<!DOCTYPE html>
<html lang="en" class="light"> <head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TextHost Pro üöÄ</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=Roboto+Mono&family=Merriweather&display=swap" rel="stylesheet">

<script>
  // Check localStorage for theme
  if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
    document.documentElement.classList.add('dark');
    localStorage.theme = 'dark';
  } else {
    document.documentElement.classList.remove('dark');
    localStorage.theme = 'light';
  }

  function toggleTheme() {
    if (localStorage.theme === 'dark') {
      localStorage.theme = 'light';
      document.documentElement.classList.remove('dark');
    } else {
      localStorage.theme = 'dark';
      document.documentElement.classList.add('dark');
    }
  }
</script>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
  import { getDatabase, ref, set, get, child } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

  // --- YOUR FIREBASE CONFIG ---
  const firebaseConfig = {
    apiKey: "AIzaSyDIIFcltH_WwkmVmjbpsROHelC3Bc5q5L8",
    authDomain: "sufi-hosting.firebaseapp.com",
    databaseURL: "https://sufi-hosting-default-rtdb.firebaseio.com",
    projectId: "sufi-hosting",
    storageBucket: "sufi-hosting.firebasestorage.app",
    messagingSenderId: "556098236259",
    appId: "1:556098236259:web:21007dc0e69d468aa66d56",
    measurementId: "G-VSSGPEED06"
  };
  // --------------------------

  const app = initializeApp(firebaseConfig);
  window.db = getDatabase(app);
</script>

<style>
  /* Define fonts for Tailwind */
  .font-roboto { font-family: 'Roboto', sans-serif; }
  .font-mono { font-family: 'Roboto Mono', monospace; }
  .font-serif { font-family: 'Merriweather', serif; }
</style>

</head>
<body class="bg-gray-100 dark:bg-gray-900 font-roboto min-h-screen flex flex-col items-center p-4 sm:p-6 transition-colors duration-200">

<div id="app-wrapper" class="w-full">
  <header class="w-full max-w-3xl mx-auto flex justify-between items-center mb-6">
    <h1 class="text-4xl font-bold text-gray-900 dark:text-white">TextHost Pro üöÄ</h1>
    <button id="themeToggleBtn" onclick="toggleTheme()" class="p-2 rounded-full text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700">
      </button>
  </header>

  <div class="w-full max-w-3xl mx-auto bg-white dark:bg-gray-800 shadow-lg rounded-lg p-6 flex flex-col gap-5">

    <div>
      <label for="slug" class="font-medium mb-1 block text-gray-800 dark:text-gray-200">Custom Link Name (Optional)</label>
      <input id="slug" placeholder="Leave blank for random unique ID" class="w-full border rounded px-3 py-2 dark:bg-gray-700 dark:text-white dark:border-gray-600 focus:ring-2 focus:ring-blue-500" />
    </div>

    <div>
      <label for="userText" class="font-medium mb-1 block text-gray-800 dark:text-gray-200">Your Text / Content</label>
      <textarea id="userText" rows="10" class="w-full border rounded px-3 py-2 dark:bg-gray-700 dark:text-white dark:border-gray-600 focus:ring-2 focus:ring-blue-500 font-mono" placeholder="Write here..."></textarea>
    </div>

    <div class="grid grid-cols-2 md:grid-cols-4 gap-3 items-center">
      <div>
        <label for="contentType" class="text-sm font-medium text-gray-600 dark:text-gray-400">Content Type</label>
        <select id="contentType" class="w-full border rounded px-2 py-1 dark:bg-gray-700 dark:text-white dark:border-gray-600">
          <option value="html">Text / HTML</option>
          <option value="plaintext">Plain Text (.txt)</option>
          <option value="json">JSON</option>
        </select>
      </div>
      <div>
        <label for="fontStyle" class="text-sm font-medium text-gray-600 dark:text-gray-400">Font Style</label>
        <select id="fontStyle" class="w-full border rounded px-2 py-1 dark:bg-gray-700 dark:text-white dark:border-gray-600">
          <option value="font-roboto">Roboto (Sans)</option>
          <option value="font-serif">Merriweather (Serif)</option>
          <option value="font-mono">Roboto Mono (Mono)</option>
          <option value="italic">Italic</option>
          <option value="font-bold">Bold</option>
        </select>
      </div>
      <div>
        <label for="fontSize" class="text-sm font-medium text-gray-600 dark:text-gray-400">Font Size (px)</label>
        <input id="fontSize" type="number" value="16" min="10" max="100" class="w-full border rounded px-2 py-1 dark:bg-gray-700 dark:text-white dark:border-gray-600" />
      </div>
      <div>
        <label for="bgColor" class="text-sm font-medium text-gray-600 dark:text-gray-400">Background</label>
        <input id="bgColor" type="color" value="#ffffff" title="Background color" class="w-full border rounded h-9 dark:border-gray-600" />
      </div>
    </div>
    
    <div class="flex justify-end items-center gap-4">
      <div id="msg" class="text-red-500 text-sm"></div>
      <button id="saveBtn" class="bg-blue-600 text-white px-5 py-2 rounded-lg hover:bg-blue-700 transition font-medium">
        Save & Get Link
      </button>
    </div>

    <div id="result" class="hidden p-4 border rounded-lg bg-gray-100 dark:bg-gray-700">
      <div class="mb-2 font-medium text-gray-900 dark:text-white">Your Hosted Link:</div>
      <a id="publicLink" href="#" target="_blank" class="text-blue-600 dark:text-blue-400 underline break-all"></a>
      <div class="flex gap-2 mt-4">
        <button id="copyBtn" class="bg-green-500 text-white px-3 py-1 rounded hover:bg-green-600 text-sm">Copy Link</button>
        <button id="downloadBtn" class="bg-orange-500 text-white px-3 py-1 rounded hover:bg-orange-600 text-sm">Download .txt</button>
      </div>
    </div>

  </div>
</div> <div id="viewer-wrapper" class="hidden">
  </div>


<script type="module">
  import { ref, set, get } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

  // --- Get Elements ---
  const saveBtn = document.getElementById('saveBtn');
  const msg = document.getElementById('msg');
  const result = document.getElementById('result');
  const publicLink = document.getElementById('publicLink');
  const copyBtn = document.getElementById('copyBtn');
  const downloadBtn = document.getElementById('downloadBtn');
  const appWrapper = document.getElementById('app-wrapper');
  const viewerWrapper = document.getElementById('viewer-wrapper');
  const themeToggleBtn = document.getElementById('themeToggleBtn');

  // --- Theme Toggle Icon ---
  function updateThemeIcon() {
    if (localStorage.theme === 'dark') {
      themeToggleBtn.innerHTML = '‚òÄÔ∏è'; // Sun icon
    } else {
      themeToggleBtn.innerHTML = 'üåô'; // Moon icon
    }
  }
  updateThemeIcon(); // Set on load
  themeToggleBtn.addEventListener('click', updateThemeIcon); // Update on click


  // --- Helper Functions ---
  function sanitizeSlug(s){
    return s.trim().replace(/[^a-zA-Z0-9\-_]/g, '-').replace(/-+/g, '-').replace(/^-+|-+$/g, '').substring(0,80);
  }

  function generateRandomSlug(length=12){
    const chars = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
    let s = '';
    for(let i=0;i<length;i++) s+=chars.charAt(Math.floor(Math.random()*chars.length));
    return s;
  }
  
  function escapeHTML(str) {
    return str.replace(/</g, '&lt;').replace(/>/g, '&gt;');
  }

  // --- Save Button Logic ---
  saveBtn.addEventListener('click', async () => {
    msg.textContent = '';
    result.classList.add('hidden');

    let slugInput = document.getElementById('slug').value;
    let slug = sanitizeSlug(slugInput);
    if(!slug) slug = generateRandomSlug();

    const text = document.getElementById('userText').value;
    const font = document.getElementById('fontStyle').value;
    const bg = document.getElementById('bgColor').value;
    const fontSize = parseInt(document.getElementById('fontSize').value)||16;
    const contentType = document.getElementById('contentType').value; // NEW

    if(!text.trim()){ msg.textContent="Please write some text üòÖ"; return; }

    saveBtn.disabled=true;
    saveBtn.textContent='Saving...';

    try{
      const dbRef = ref(window.db,'texts/'+slug);
      const snapshot = await get(dbRef);
      
      if(snapshot.exists() && slugInput){ // Only block if user *chose* an existing slug
         msg.textContent="This custom link name already exists üîë"; 
         return; 
      }

      // Save all data
      await set(dbRef, {text, font, bg, fontSize, slug, contentType, created:Date.now()});

      const url = location.origin + location.pathname + '?view=' + encodeURIComponent(slug);
      publicLink.href=url;
      publicLink.textContent=url;
      result.classList.remove('hidden');
    }catch(e){ msg.textContent=e.message; }
    finally{ saveBtn.disabled=false; saveBtn.textContent='Save & Get Link'; }
  });

  // --- Result Buttons Logic ---
  copyBtn.addEventListener('click',()=>{ navigator.clipboard.writeText(publicLink.href).then(()=>alert('Link copied ‚úÖ')); });
  
  downloadBtn.addEventListener('click',()=>{
    const text = document.getElementById('userText').value;
    const contentType = document.getElementById('contentType').value;
    let extension = '.txt';
    let mime = 'text/plain';

    if (contentType === 'json') {
      extension = '.json';
      mime = 'application/json';
    } else if (contentType === 'html') {
      extension = '.html';
      mime = 'text/html';
    }
    
    const blob = new Blob([text], {type: mime});
    const a=document.createElement('a');
    a.href=URL.createObjectURL(blob);
    a.download=(document.getElementById('slug').value||'text')+ extension;
    a.click();
  });

  // --- Load Text Logic (VIEWER) ---
  async function loadText(){
    const params = new URLSearchParams(window.location.search);
    const slug = params.get('view'); 
    if(!slug) return; // No slug, just show the app

    // Slug exists, so hide app and show viewer
    appWrapper.classList.add('hidden');
    viewerWrapper.classList.remove('hidden');
    document.body.innerHTML = ''; // Clear the entire body to only show the content

    try {
      const dbRef = ref(window.db,'texts/'+slug);
      const snapshot = await get(dbRef);
      if(!snapshot.exists()){ 
        document.body.innerHTML = `<div class="p-6 text-red-500">Text not found ‚ùå</div>`;
        return; 
      }

      const data = snapshot.val();
      let contentHTML = '';

      // --- Format content based on Content Type ---
      switch(data.contentType) {
        case 'plaintext':
          contentHTML = `<pre class="whitespace-pre-wrap break-words">${escapeHTML(data.text)}</pre>`;
          break;
        case 'json':
          try {
            const prettyJSON = JSON.stringify(JSON.parse(data.text), null, 2);
            contentHTML = `<pre class="whitespace-pre-wrap break-words">${escapeHTML(prettyJSON)}</pre>`;
          } catch (jsonError) {
            // It's invalid JSON, so just show as plain text
            contentHTML = `<div class="text-red-500 mb-4">Invalid JSON, showing as plain text:</div><pre class="whitespace-pre-wrap break-words">${escapeHTML(data.text)}</pre>`;
          }
          break;
        case 'html':
        default:
          // Default is HTML, so we DON'T escape it and we add line breaks
          contentHTML = data.text.replace(/\n/g,'<br>');
          break;
      }
      
      // --- Set the new page content ---
      document.body.style.background = data.bg; // Set background color
      viewerWrapper.innerHTML =`
        <div class="min-h-screen flex flex-col items-center justify-center p-6">
          <div class="w-full max-w-4xl p-6 border rounded shadow-lg ${data.font}" style="background: ${data.bg}; font-size: ${data.fontSize}px;">
            ${contentHTML}
          </div>
        </div>
      `;
      // Put the content into the wrapper, and the wrapper into the body
      document.body.appendChild(viewerWrapper);

    } catch (e) {
      document.body.innerHTML = `<div class="p-6 text-red-500">Error: ${e.message}</div>`;
    }
  }

  loadText(); // Run on page load

</script>
</body>
</html>
